// ============================================================================
// Jenkins Pipeline for Phase 1: Static Website
// ============================================================================

pipeline {
    agent any
    
    environment {
        NEXUS_REGISTRY = '192.168.0.33:5000'
        NEXUS_REPO = 'docker-hosted'
        IMAGE_NAME = 'static-site'
        IMAGE_TAG = "${BUILD_NUMBER}"
        FULL_IMAGE_NAME = "${NEXUS_REGISTRY}/${IMAGE_NAME}:${IMAGE_TAG}"
        K8S_NAMESPACE = 'default'
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo 'üì• Checking out source code from GitHub...'
                checkout scm
                sh 'ls -R'
                echo "Workspace path: ${WORKSPACE}"
            }
        }
        
        stage('Build Image') {
            steps {
                echo 'üî® Building Docker image...'
                script {
                    sh """
                        cd phase1-static-site
                        docker build -t ${FULL_IMAGE_NAME} .
                        docker tag ${FULL_IMAGE_NAME} ${NEXUS_REGISTRY}/${IMAGE_NAME}:latest
                        docker images | grep static-site
                    """
                }
                echo "‚úÖ Docker image built successfully: ${FULL_IMAGE_NAME}"
            }
        }
        
        stage('Test Image') {
    steps {
        echo 'üß™ Testing Docker image...'
        script {
            sh """
                # Remove any existing test-container from previous runs
                docker rm -f test-container || true
                
                # Start container in background
                echo "Starting test container..."
                docker run -d --name test-container -p 8888:80 ${FULL_IMAGE_NAME}
                
                # Get container ID for reference
                CONTAINER_ID=\$(docker ps -q -f name=test-container)
                echo "Container ID: \$CONTAINER_ID"
                
                # Wait longer for Nginx to fully start
                echo "Waiting for Nginx service to start (15 seconds)..."
                sleep 15
                
                # Verify container is still running
                echo "Checking if container is running..."
                if ! docker ps -f name=test-container --quiet | grep -q .; then
                    echo "ERROR: Container stopped unexpectedly!"
                    echo "Container logs:"
                    docker logs test-container || true
                    exit 1
                fi
                
                echo "Container is running. Testing HTTP connectivity..."
                
                # Try to connect with retries (up to 5 attempts, 3 seconds apart)
                RETRY_COUNT=0
                MAX_RETRIES=5
                while [ \$RETRY_COUNT -lt \$MAX_RETRIES ]; do
                    RETRY_COUNT=\$((RETRY_COUNT + 1))
                    echo "Connection attempt \$RETRY_COUNT of \$MAX_RETRIES..."
                    
                    if curl -f -m 5 http://localhost:8888 > /dev/null 2>&1; then
                        echo "‚úì Successfully connected to Nginx service on port 8888"
                        break
                    fi
                    
                    if [ \$RETRY_COUNT -lt \$MAX_RETRIES ]; then
                        echo "Connection failed. Waiting 3 seconds before retry..."
                        sleep 3
                    else
                        echo "ERROR: Failed to connect after \$MAX_RETRIES attempts"
                        echo "Container logs for debugging:"
                        docker logs test-container || true
                        exit 1
                    fi
                done
                
                # Cleanup: stop and remove test container
                echo "Cleaning up test container..."
                docker stop test-container || true
                docker rm test-container || true
            """
        }
        echo '‚úÖ Docker image test passed successfully'
    }
}

        
        stage('Push to Nexus') {
            steps {
                echo 'üì§ Pushing Docker image to Nexus registry...'
                script {
                    sh """
                        echo "Pushing ${FULL_IMAGE_NAME}..."
                        docker push ${FULL_IMAGE_NAME}
                        echo "Pushing ${NEXUS_REGISTRY}/${IMAGE_NAME}:latest..."
                        docker push ${NEXUS_REGISTRY}/${IMAGE_NAME}:latest
                    """
                }
                echo "‚úÖ Docker image pushed to Nexus successfully"
            }
        }
        
        stage('Deploy to K8s') {
            environment {
                KUBECONFIG = '/home/ansible/.kube/config'
            }
            steps {
                echo 'üöÄ Deploying application to Kubernetes cluster...'
                script {
                    sh """
                        echo "Creating/updating Kubernetes deployment..."
                        kubectl apply -f phase1-static-site/k8s/deployment.yaml --namespace=${K8S_NAMESPACE}
                        echo "Creating/updating Kubernetes service..."
                        kubectl apply -f phase1-static-site/k8s/service.yaml --namespace=${K8S_NAMESPACE}
                        echo "Updating deployment with new image: ${FULL_IMAGE_NAME}..."
                        kubectl set image deployment/static-site nginx=${FULL_IMAGE_NAME} --namespace=${K8S_NAMESPACE} --record
                        echo "Waiting for rollout to complete..."
                        kubectl rollout status deployment/static-site --namespace=${K8S_NAMESPACE} --timeout=5m
                    """
                }
                echo '‚úÖ Kubernetes deployment successful'
            }
        }
        
        stage('Verify') {
            steps {
                echo '‚úîÔ∏è Verifying Kubernetes deployment...'
                script {
                    sh """
                        echo "=== Deployment Status ==="
                        kubectl get deployment static-site --namespace=${K8S_NAMESPACE}
                        echo ""
                        echo "=== Running Pods ==="
                        kubectl get pods -l app=static-site --namespace=${K8S_NAMESPACE}
                        echo ""
                        echo "=== Service Information ==="
                        kubectl get svc static-site --namespace=${K8S_NAMESPACE}
                    """
                }
                echo '‚úÖ Deployment verification complete'
            }
        }
    }
    
    post {
        always {
            echo 'üßπ Cleaning up local Docker images...'
            script {
                sh """
                    echo "Removing Docker image: ${FULL_IMAGE_NAME}"
                    docker rmi -f ${FULL_IMAGE_NAME} || true
                    echo "Removing Docker image: ${NEXUS_REGISTRY}/${IMAGE_NAME}:latest"
                    docker rmi -f ${NEXUS_REGISTRY}/${IMAGE_NAME}:latest || true
                    echo "Cleanup complete"
                """
            }
        }
        
        success {
            echo '‚úÖ Pipeline completed successfully!'
            echo "Image Name: ${FULL_IMAGE_NAME}"
            echo "Nexus Registry: ${NEXUS_REGISTRY}"
            echo "Kubernetes Namespace: ${K8S_NAMESPACE}"
        }
        
        failure {
            echo '‚ùå Pipeline failed!'
            echo "Check console output above for error details"
        }
    }
}
