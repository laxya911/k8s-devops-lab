// ============================================================================
// Jenkins Pipeline for Phase 1: Static Website
// ============================================================================

pipeline {
    agent any
    
    environment {
        NEXUS_REGISTRY = '192.168.0.33:5000'
        NEXUS_REPO = 'docker-hosted'
        IMAGE_NAME = 'static-site'
        IMAGE_TAG = "${BUILD_NUMBER}"
        FULL_IMAGE_NAME = "${NEXUS_REGISTRY}/${IMAGE_NAME}:${IMAGE_TAG}"
        K8S_NAMESPACE = 'jenkins'
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo 'üì• Checking out source code from GitHub...'
                checkout scm
                sh 'ls -R'
                echo "Workspace path: ${WORKSPACE}"
            }
        }
        
        stage('Build Image') {
            steps {
                echo 'üî® Building Docker image...'
                script {
                    sh """
                        cd phase1-static-site
                        docker build -t ${FULL_IMAGE_NAME} .
                        docker tag ${FULL_IMAGE_NAME} ${NEXUS_REGISTRY}/${IMAGE_NAME}:latest
                        docker images | grep static-site
                    """
                }
                echo "‚úÖ Docker image built successfully: ${FULL_IMAGE_NAME}"
            }
        }
        
        stage('Test Image') {
            steps {
                echo 'üß™ Testing Docker image...'
                script {
                    sh """
                        # Remove any existing test-container from previous runs
                        docker rm -f test-container || true
                        
                        # Start container in background with port mapping
                        echo "Starting test container..."
                        docker run -d --name test-container -p 8888:80 ${FULL_IMAGE_NAME}
                        
                        # Wait for Nginx to fully initialize
                        echo "Waiting for Nginx service to start..."
                        sleep 15
                        
                        # Verify container is running
                        echo "Verifying container is running..."
                        if docker ps -f name=test-container --quiet | grep -q .; then
                            echo "‚úì Container is running successfully"
                        else
                            echo "ERROR: Container stopped unexpectedly!"
                            docker logs test-container || true
                            exit 1
                        fi
                        
                        # Check container health from logs
                        echo "Checking container startup status..."
                        docker logs test-container 2>&1 | tail -5
                        
                        # Cleanup test container
                        echo "Cleaning up test container..."
                        docker stop test-container || true
                        docker rm test-container || true
                    """
                }
                echo '‚úÖ Docker image test passed successfully'
            }
        }
        
        stage('Push to Nexus') {
            steps {
                echo 'üì§ Pushing Docker image to Nexus registry...'
                script {
                    sh """
                        echo "Pushing ${FULL_IMAGE_NAME}..."
                        docker push ${FULL_IMAGE_NAME}
                        echo "Pushing ${NEXUS_REGISTRY}/${IMAGE_NAME}:latest..."
                        docker push ${NEXUS_REGISTRY}/${IMAGE_NAME}:latest
                    """
                }
                echo "‚úÖ Docker image pushed to Nexus successfully"
            }
        }
        
        stage('Deploy to K8s') {
            environment {
                KUBECONFIG = '/home/ansible/.kube/config'
            }
            steps {
                echo 'üöÄ Deploying application to Kubernetes cluster...'
                script {
                    sh """
                        echo "Creating/updating Kubernetes deployment..."
                        kubectl apply -f phase1-static-site/k8s/deployment.yaml --namespace=${K8S_NAMESPACE}
                        echo "Creating/updating Kubernetes service..."
                        kubectl apply -f phase1-static-site/k8s/service.yaml --namespace=${K8S_NAMESPACE}
                        echo "Updating deployment with new image: ${FULL_IMAGE_NAME}..."
                        kubectl set image deployment/static-site nginx=${FULL_IMAGE_NAME} --namespace=${K8S_NAMESPACE} --record
                        echo "Waiting for rollout to complete..."
                        kubectl rollout status deployment/static-site --namespace=${K8S_NAMESPACE} --timeout=5m
                    """
                }
                echo '‚úÖ Kubernetes deployment successful'
            }
        }
        
        stage('Verify') {
            steps {
                echo '‚úîÔ∏è Verifying Kubernetes deployment...'
                script {
                    sh """
                        echo "=== Deployment Status ==="
                        kubectl get deployment static-site --namespace=${K8S_NAMESPACE}
                        echo ""
                        echo "=== Running Pods ==="
                        kubectl get pods -l app=static-site --namespace=${K8S_NAMESPACE}
                        echo ""
                        echo "=== Service Information ==="
                        kubectl get svc static-site --namespace=${K8S_NAMESPACE}
                    """
                }
                echo '‚úÖ Deployment verification complete'
            }
        }
    }
    
    post {
        always {
            echo 'üßπ Cleaning up local Docker images...'
            script {
                sh """
                    echo "Removing Docker image: ${FULL_IMAGE_NAME}"
                    docker rmi -f ${FULL_IMAGE_NAME} || true
                    echo "Removing Docker image: ${NEXUS_REGISTRY}/${IMAGE_NAME}:latest"
                    docker rmi -f ${NEXUS_REGISTRY}/${IMAGE_NAME}:latest || true
                    echo "Cleanup complete"
                """
            }
        }
        
        success {
            echo '‚úÖ Pipeline completed successfully!'
            echo "Image Name: ${FULL_IMAGE_NAME}"
            echo "Nexus Registry: ${NEXUS_REGISTRY}"
            echo "Kubernetes Namespace: ${K8S_NAMESPACE}"
            echo "Application successfully deployed and running!"
        }
        
        failure {
            echo '‚ùå Pipeline failed!'
            echo "Check console output above for error details"
        }
    }
}
