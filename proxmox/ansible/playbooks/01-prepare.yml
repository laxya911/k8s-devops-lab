################################################################################
# ANSIBLE PLAYBOOK 01: BASE SYSTEM PREPARATION
#
# PURPOSE:
# - Common configuration for ALL hosts
# - Safe to run multiple times
# - LXC-aware (no kernel/sysctl mistakes)
# - Docker strategy fixed (Docker CE only)
#
# WHY THIS VERSION EXISTS:
# - Avoids docker.io vs containerd.io conflicts
# - Avoids sysctl/modprobe failures in LXC
# - Avoids hostname/DNS mistakes
################################################################################

# ==============================================================================
# BASE SYSTEM PREPARATION
# ==============================================================================

---
- name: Prepare all systems (base configuration)
  hosts: project_lab
  become: true
  gather_facts: true
  
  tasks:

    # ==========================================================================
    # SYSTEM UPDATE & BASE PACKAGES
    # ==========================================================================

    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Upgrade all installed packages
      apt:
        upgrade: dist
        autoremove: yes
        autoclean: yes

    - name: Install base utility packages
      apt:
        name:
          - curl
          - wget
          - git
          - vim
          - htop
          - net-tools
          - ca-certificates
          - apt-transport-https
          - software-properties-common
          - jq
          - unzip
          - python3
          - python3-pip
        state: present

    # ==========================================================================
    # USER MANAGEMENT
    # ==========================================================================

    - name: Ensure ubuntu user exists
      user:
        name: ubuntu
        groups: sudo
        shell: /bin/bash
        append: yes
        state: present

    - name: Allow ubuntu user passwordless sudo
      copy:
        dest: /etc/sudoers.d/ubuntu
        content: "ubuntu ALL=(ALL) NOPASSWD:ALL\n"
        owner: root
        group: root
        mode: '0440'

    # ==========================================================================
    # HOSTNAME & HOSTS FILE
    # ==========================================================================

    - name: Set system hostname from inventory
      hostname:
        name: "{{ inventory_hostname }}"

    - name: Ensure hostname is in /etc/hosts
      lineinfile:
        path: /etc/hosts
        regexp: "^127.0.1.1"
        line: "127.0.1.1 {{ inventory_hostname }}"
        state: present

    # ==========================================================================
    # SWAP (REQUIRED FOR KUBERNETES)
    # ==========================================================================

    - name: Disable swap immediately
      command: swapoff -a
      ignore_errors: true

    - name: Remove swap entries from /etc/fstab
      replace:
        path: /etc/fstab
        regexp: '^([^#].*swap.*)$'
        replace: '# \1'

    # ==========================================================================
    # KUBERNETES PREPARATION (LXC-SAFE)
    #
    # NOTE:
    # - Kernel modules are handled by Proxmox host
    # - These files are informational only
    # ==========================================================================

    - name: Document Kubernetes-required kernel modules
      copy:
        dest: /etc/modules-load.d/kubernetes.conf
        content: |
          overlay
          br_netfilter

    # ==========================================================================
    # FIREWALL (SAFE BASELINE)
    # ==========================================================================

    - name: Ensure UFW is installed
      apt:
        name: ufw
        state: present

    - name: Allow SSH
      ufw:
        rule: allow
        port: '22'
        proto: tcp

    - name: Enable UFW (default deny incoming)
      ufw:
        state: enabled
        policy: deny
        direction: incoming

    # ==========================================================================
    # VERIFICATION
    # ==========================================================================

    - name: Verify swap is disabled
      command: free -h
      register: swap_status
      changed_when: false

    - name: Display swap status
      debug:
        msg: "{{ swap_status.stdout }}"


    # ==========================================================================
    # QEMU GUEST AGENT
    # ==========================================================================

    - name: Install QEMU guest agent
      apt:
        name: qemu-guest-agent
        state: present

    - name: Enable and start qemu-guest-agent
      systemd:
        name: qemu-guest-agent
        enabled: yes
        state: started

