################################################################################
# ANSIBLE PLAYBOOK 2: KUBERNETES MASTER NODE SETUP
# Installs K3s master (lightweight Kubernetes distribution)
################################################################################

---
- name: Setup Kubernetes Master Node (K3s)
  hosts: kubernetes_master
  become: true
  gather_facts: true

  vars:
    k3s_version: "v1.28.3"
    k3s_release_url: "https://github.com/k3s-io/k3s/releases/download"

  tasks:
    # ========================================================================
    # K3S INSTALLATION
    # ========================================================================

    - name: Check if K3s is already installed
      stat:
        path: /usr/local/bin/k3s
      register: k3s_binary

    - name: Download K3s installer
      get_url:
        url: "{{ k3s_release_url }}/{{ k3s_version }}/k3s"
        dest: /tmp/k3s
        mode: '0755'
      when: not k3s_binary.stat.exists

    - name: Install K3s master
      shell: |
        /tmp/k3s server \
        --disable traefik \
        --disable servicelb \
        --advertise-address={{ hostvars['kube-master']['ansible_host'] }} \
        --node-ip={{ hostvars['kube-master']['ansible_host'] }}
      when: not k3s_binary.stat.exists
      async: 300
      poll: 10

    - name: Wait for K3s to be ready
      shell: kubectl get nodes
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml
      register: kubectl_result
      until: kubectl_result.rc == 0
      retries: 30
      delay: 10

    # ========================================================================
    # KUBECONFIG SETUP
    # ========================================================================

    - name: Create .kube directory
      file:
        path: /home/ubuntu/.kube
        state: directory
        owner: ubuntu
        group: ubuntu
        mode: '0755'

    - name: Copy kubeconfig to ubuntu user
      copy:
        src: /etc/rancher/k3s/k3s.yaml
        dest: /home/ubuntu/.kube/config
        owner: ubuntu
        group: ubuntu
        mode: '0600'
        remote_src: yes

    - name: Update kubeconfig with correct IP
      shell: |
        sed -i 's/127.0.0.1/{{ hostvars['kube-master']['ansible_host'] }}/g' /home/ubuntu/.kube/config

    # ========================================================================
    # KUBERNETES ADDONS
    # ========================================================================

    - name: Install Flannel CNI (if not already installed by K3s)
      shell: |
        kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml
      ignore_errors: yes

    - name: Install metrics-server
      shell: |
        kubectl apply -f https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml

    # ========================================================================
    # RBAC AND SERVICE ACCOUNTS
    # ========================================================================

    - name: Create monitoring namespace
      shell: |
        kubectl create namespace monitoring || true
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml

    - name: Create jenkins namespace
      shell: |
        kubectl create namespace jenkins || true
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml

    - name: Create default service account for jenkins
      shell: |
        kubectl create serviceaccount jenkins -n jenkins || true
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml

    # ========================================================================
    # VERIFICATION
    # ========================================================================

    - name: Get K3s cluster info
      shell: kubectl cluster-info
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml
      register: cluster_info

    - name: Display cluster info
      debug:
        msg: "{{ cluster_info.stdout }}"

    - name: Get nodes status
      shell: kubectl get nodes -o wide
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml
      register: nodes_status

    - name: Display nodes
      debug:
        msg: "{{ nodes_status.stdout }}"

    - name: Get K3s server token for workers
      shell: cat /var/lib/rancher/k3s/server/node-token
      register: k3s_token

    - name: Save K3s token for workers
      copy:
        content: "{{ k3s_token.stdout }}"
        dest: /tmp/k3s-token.txt
        mode: '0644'

    # ========================================================================
    # FIREWALL RULES
    # ========================================================================

    - name: Allow Kubernetes API port (6443)
      ufw:
        rule: allow
        port: '6443'
        proto: tcp

    - name: Allow etcd ports (2379-2380)
      ufw:
        rule: allow
        port: 2379:2380
        proto: tcp

    - name: Allow kubelet port (10250)
      ufw:
        rule: allow
        port: '10250'
        proto: tcp

    - name: Allow scheduler port (10259)
      ufw:
        rule: allow
        port: '10259'
        proto: tcp

    - name: Allow controller manager port (10257)
      ufw:
        rule: allow
        port: '10257'
        proto: tcp
